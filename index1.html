<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MySnowBox</title>
  <style>
    body { font-family: sans-serif; margin: 0; background: #f0f8ff; }
    header, .login-panel, .main-ui { max-width: 800px; margin: auto; padding: 2rem; }
    .hidden { display: none; }
    input, select, button, textarea {
      padding: 0.5rem; margin: 0.5rem 0; width: 100%; font-size: 1rem;
    }
    button { background-color: #10b981; color: white; border: none; cursor: pointer; }
    button:hover { background-color: #059669; }
    .error { color: red; text-align: center; font-size: 0.9rem; }
    .gallery { display: flex; flex-wrap: wrap; gap: 1rem; }
    .gallery img { width: 150px; height: auto; border-radius: 8px; box-shadow: 0 0 4px rgba(0,0,0,0.2); }
    .gallery-item { position: relative; display: inline-block; }
    .gallery-item button { position: absolute; top: 4px; right: 4px; background: #ef4444; width: auto; padding: 0.25rem 0.5rem; }
    .responsive-row {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    margin-bottom: 1rem;
  }
  .responsive-row > * {
    flex: 1 1 200px;
    min-width: 150px;
  }
  .gallery {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
  }
  .gallery-item {
    position: relative;
  }
  .gallery-item img {
    max-width: 100%;
    border-radius: 6px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  }
  .gallery-item button {
    position: absolute;
    top: 4px;
    right: 4px;
    background: crimson;
    color: white;
    border: none;
    padding: 0.25rem 0.5rem;
    cursor: pointer;
    border-radius: 4px;
  }
  .status {
    margin-bottom: 1rem;
    color: green;
  }
  @media (max-width: 600px) {
    .responsive-row {
      flex-direction: column;
    }
    .gallery {
      justify-content: center;
    }
  }
  </style>
</head>
<body>
  <header>
    <h2>MySnowBox ‚ùÑÔ∏è</h2>
  </header>
<!-- üîê Admin Panel -->
<div id="admin-panel" class="hidden" style="border-top:1px solid #ccc; margin-top:2rem; padding-top:1rem;">
  <h3>üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)</h3>
  <div class="responsive-row">
    <input type="text" id="newUsername" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà">
    <input type="text" id="newPassword" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
    <select id="newRole">
      <option value="user">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option>
      <option value="admin">‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•</option>
    </select>
    <button onclick="addUser()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>
  </div>
  <div id="userStatus" class="status"></div>

  <h4>üìã ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h4>
  <ul id="userList"></ul>

  <h3 style="margin-top:2rem;">üìä Dashboard ‡∏†‡∏≤‡∏û‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
  <div class="responsive-row">
    <label>‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ:</label>
    <select id="filterUser" onchange="loadAdminGallery()">
      <option value="">-- ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô --</option>
    </select>
    <label>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏•‡∏±‡∏Å:</label>
    <select id="filterMain" onchange="loadAdminGallery()">
      <option value="">-- ‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î --</option>
    </select>
    <button onclick="downloadCSV()">üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î CSV</button>
  </div>
  <div id="admin-gallery" class="gallery"></div>
</div>

  <!-- üîê Login Section -->
  <section class="login-panel" id="login-section">
    <h3>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h3>
    <input type="text" id="login-username" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ">
    <input type="password" id="login-password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
    <div class="error" id="login-error"></div>
    <button onclick="login()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
  </section>

  <!-- ‚úÖ Main UI -->
  <section class="main-ui hidden" id="main-section">
    <div style="text-align:right">
      <button onclick="logout()" style="width:auto; background:#ef4444;">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>
    <div id="user-info"></div>

    <h4>üìÅ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏°‡∏ß‡∏î‡πÉ‡∏´‡∏°‡πà</h4>
    <input type="text" id="newMainCategory" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏•‡∏±‡∏Å">
    <input type="text" id="newSubCategory" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏¢‡πà‡∏≠‡∏¢ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)">
    <button onclick="createCategory()">‚ûï ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏°‡∏ß‡∏î</button>
    <div id="createStatus"></div>

    <h4>üì§ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û</h4>
    <select id="mainCategory"></select>
    <select id="subCategory"></select>
    <input type="file" id="imageFile" accept="image/*">
    <button onclick="uploadImage()">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î</button>
    <div id="uploadStatus"></div>

    <h4>üñºÔ∏è ‡πÅ‡∏Å‡∏•‡πÄ‡∏•‡∏≠‡∏£‡∏µ‡πà‡∏†‡∏≤‡∏û</h4>
    <div id="gallery" class="gallery"></div>
  </section>

  <script>
    function switchTab(tabName) {
  ['gallery','upload','category','admin'].forEach(tab => {
    document.getElementById(`tab-${tab}`).classList.add('hidden');
  });
  document.getElementById(`tab-${tabName}`).classList.remove('hidden');
}
    const API_URL = 'https://script.google.com/macros/s/AKfycbzub40tiSGk1QS5_iBk3M-6L-X3y78XnFyyR-iQGuV9CtKea5vBQyiugI6tybi4FDxJ/exec';

    async function login() {
      const username = document.getElementById('login-username').value.trim();
      const password = document.getElementById('login-password').value.trim();
      const errorBox = document.getElementById('login-error');

      if (!username || !password) {
        errorBox.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô'; return;
      }

      const res = await fetch(`${API_URL}?action=login&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`);
      const data = await res.json();

      if (data.success) {
        localStorage.setItem('mysnowbox_user', username);
        localStorage.setItem('mysnowbox_role', data.role);
        document.getElementById('login-section').classList.add('hidden');
        document.getElementById('main-section').classList.remove('hidden');
        document.getElementById('user-info').textContent = `üë§ ${username} (${data.role})`;
        loadCategories();
        loadGallery();
      } else {
        errorBox.textContent = data.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
      }
    }

    function logout() {
      localStorage.clear();
      location.reload();
    }

    async function loadCategories() {
      const res = await fetch(`${API_URL}?action=getCategories`);
      const data = await res.json();
      const mainSelect = document.getElementById('mainCategory');
      const subSelect = document.getElementById('subCategory');

      mainSelect.innerHTML = '<option value="">üìÅ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏•‡∏±‡∏Å</option>';
      subSelect.innerHTML = '<option value="">üìÇ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏¢‡πà‡∏≠‡∏¢</option>';

      data.data.main.forEach(main => {
        const opt = document.createElement('option');
        opt.value = main;
        opt.textContent = main;
        mainSelect.appendChild(opt);
      });

      mainSelect.onchange = () => {
        const selected = mainSelect.value;
        subSelect.innerHTML = '<option value="">üìÇ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏¢‡πà‡∏≠‡∏¢</option>';
        if (data.data.sub[selected]) {
          data.data.sub[selected].forEach(sub => {
            const opt = document.createElement('option');
            opt.value = sub;
            opt.textContent = sub;
            subSelect.appendChild(opt);
          });
        }
      };
    }

    async function uploadImage() {
      const fileInput = document.getElementById('imageFile');
      const mainCategory = document.getElementById('mainCategory').value;
      const subCategory = document.getElementById('subCategory').value;
      const status = document.getElementById('uploadStatus');
      const username = localStorage.getItem('mysnowbox_user');

      if (!fileInput.files.length || !mainCategory || !subCategory) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡πÅ‡∏•‡∏∞‡∏†‡∏≤‡∏û'); return;
      }

      const reader = new FileReader();
      reader.onload = async function(e) {
        const base64 = e.target.result.split(',')[1];
        const formData = new FormData();
        formData.append('action', 'uploadImage');
        formData.append('username', username);
        formData.append('mainCategory', mainCategory);
        formData.append('subCategory', subCategory);
        formData.append('image', base64);

        const res = await fetch(API_URL, { method: 'POST', body: formData });
        const result = await res.json();
        if (result.success) {
          status.innerText = '‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
          fileInput.value = '';
          loadGallery();
        } else {
          status.innerText = '‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î';
        }
      };
      reader.readAsDataURL(fileInput.files[0]);
    }

    async function createCategory() {
      const main = document.getElementById('newMainCategory').value.trim();
      const sub = document.getElementById('newSubCategory').value.trim();
      const status = document.getElementById('createStatus');

      if (!main) {
        status.textContent = '‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏•‡∏±‡∏Å'; return;
      }

      const formData = new FormData();
      formData.append('action', 'createCategoryFolders');
      formData.append('mainCategory', main);
      if (sub) formData.append('subCategory', sub);

      const res = await fetch(API_URL, { method: 'POST', body: formData });
      const result = await res.json();
      if (result.success) {
        status.textContent = '‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏°‡∏ß‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢';
        loadCategories();
      } else {
        status.textContent = '‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏°‡∏ß‡∏î';
      }
    }

    async function loadGallery() {
      const res = await fetch(`${API_URL}?action=getImages`);
      const data = await res.json();
      const gallery = document.getElementById('gallery');
      const username = localStorage.getItem('mysnowbox_user');
      gallery.innerHTML = '';

      data.data.filter(img => img.username === username).forEach(img => {
        const item = document.createElement('div');
        item.className = 'gallery-item';
        item.innerHTML = `
          <img src="${img.url}" alt="${img.filename}" />
          <button onclick="deleteImageByFilename('${img.filename}')">üóëÔ∏è</button>
        `;
        gallery.appendChild(item);
      });
    }

    async function deleteImageByFilename(filename) {
      if (!confirm(`‡∏•‡∏ö‡∏†‡∏≤‡∏û ${filename}?`)) return;
      const formData = new FormData();
      formData.append('action', 'deleteImage');
      formData.append('filename', filename);
      const res = await fetch(API_URL, { method: 'POST', body: formData });
      const result = await res.json();
      if (result.success) {
        alert('‚úÖ ‡∏•‡∏ö‡∏†‡∏≤‡∏û‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        loadGallery();
      } else {
        alert('‚ùå ‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + result.message);
      }
    }

    window.addEventListener('load', () => {
      const user = localStorage.getItem('mysnowbox_user');
      const role = localStorage.getItem('mysnowbox_role');
      if (user && role) {
        document.getElementById('login-section').classList.add('hidden');
        document.getElementById('main-section').classList.remove('hidden');
        document.getElementById('user-info').textContent = `üë§ ${user} (${role})`;
        loadCategories();
        loadGallery();
      }
    });
    async function addUser() {
const username = document.getElementById('newUsername').value.trim();
  const password = document.getElementById('newPassword').value.trim();
  const role = document.getElementById('newRole').value;
  const statusBox = document.getElementById('userStatus');

  if (!username || !password) {
    statusBox.textContent = '‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö'; return;
  }

  const formData = new FormData();
  formData.append('action', 'addUser');
  formData.append('username', username);
  formData.append('password', password);
  formData.append('role', role);

  const res = await fetch(API_URL, { method: 'POST', body: formData });
  const result = await res.json();
  if (result.success) {
    statusBox.textContent = '‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
    loadUserList();
  } else {
    statusBox.textContent = '‚ùå ' + (result.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ');
  }
}

async function loadUserList() {
  const res = await fetch(`${API_URL}?action=getUsers`);
  const data = await res.json();
  const list = document.getElementById('userList');
  const filter = document.getElementById('filterUser');
  list.innerHTML = '';
  filter.innerHTML = '<option value="">-- ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô --</option>';
  data.users.forEach(user => {
    const li = document.createElement('li');
    li.innerHTML = `${user.username} (${user.role}) <button onclick="deleteUser('${user.username}')">‡∏•‡∏ö</button>`;
    list.appendChild(li);

    const opt = document.createElement('option');
    opt.value = user.username;
    opt.textContent = user.username;
    filter.appendChild(opt);
  });
}



async function deleteUser(username) {
  if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ${username}?`)) return;
  const currentUser = localStorage.getItem('mysnowbox_user');
  if (username === currentUser) {
    alert('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô'); return;
  }
  const formData = new FormData();
  formData.append('action', 'deleteUser');
  formData.append('username', username);

  const res = await fetch(API_URL, { method: 'POST', body: formData });
  const result = await res.json();
  if (result.success) {
    alert('‚úÖ ‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
    loadUserList();
  } else {
    alert('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: ' + result.message);
  }
}
async function loadAdminGallery() {
  const res = await fetch(`${API_URL}?action=getImages`);
  const data = await res.json();
  const adminGallery = document.getElementById('admin-gallery');
  const selectedUser = document.getElementById('filterUser').value;
  const selectedMain = document.getElementById('filterMain').value;
  adminGallery.innerHTML = '';

  data.data.forEach(img => {
    if ((selectedUser === '' || img.username === selectedUser) &&
        (selectedMain === '' || img.mainCategory === selectedMain)) {
      const item = document.createElement('div');
      item.className = 'gallery-item';
      item.innerHTML = `
        <img src="${img.url}" alt="${img.filename}" title="${img.username}" />
        <button onclick="deleteImageByFilename('${img.filename}')">üóëÔ∏è</button>
      `;
      adminGallery.appendChild(item);
    }
  });
}

async function downloadCSV() {
  const res = await fetch(`${API_URL}?action=getImages`);
  const data = await res.json();
  let csv = 'Filename,Username,MainCategory,SubCategory,ImageURL,Date\n';
  data.data.forEach(row => {
    csv += `${row.filename},${row.username},${row.mainCategory},${row.subCategory},${row.url},${row.date}\n`;
  });
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.setAttribute('href', url);
  link.setAttribute('download', 'mysnowbox_data.csv');
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

async function loadAdminMainCategories() {
  const res = await fetch(`${API_URL}?action=getCategories`);
  const data = await res.json();
  const mainSelect = document.getElementById('filterMain');
  mainSelect.innerHTML = '<option value="">-- ‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î --</option>';
  data.data.main.forEach(main => {
    const opt = document.createElement('option');
    opt.value = main;
    opt.textContent = main;
    mainSelect.appendChild(opt);
  });
}

window.addEventListener('load', () => {
  const user = localStorage.getItem('mysnowbox_user');
  const role = localStorage.getItem('mysnowbox_role');
  if (user && role) {
    document.getElementById('login-section').classList.add('hidden');
    document.getElementById('main-section').classList.remove('hidden');
    document.getElementById('user-info').textContent = `üë§ ${user} (${role})`;
    loadCategories();
    loadGallery();
    if (role === 'admin') {
      document.getElementById('admin-panel').classList.remove('hidden');
      loadUserList();
      loadAdminGallery();
      loadAdminMainCategories();
    }
  }
});
  </script>
</body>
</html>
